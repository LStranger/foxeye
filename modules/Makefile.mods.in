#
# Makefile for module compilation.
#
# This file is part of FoxEye distribution.
# Copiright (C) 1999-2010 Andrej Gritsenko <andrej@rep.kiev.ua>

SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@
pkglibdir = @libdir@/@PACKAGE@
datadir = @prefix@/share
pkgdatadir = $(datadir)/@PACKAGE@
helpdir = $(pkglibdir)/help
docdir = $(datadir)/doc/@PACKAGE@-@VERSION@

INCLUDES = -I${top_srcdir}/tree -I${top_srcdir}/core -I${top_srcdir}/ui
INSTALL = @INSTALL@ -m 644
mkinstalldirs = $(SHELL) ${top_srcdir}/mkinstalldirs
DEFS = @DEFS@ -DSCRIPTSDIR=\"$(pkgdatadir)\"
CFLAGS = -c @CFLAGS@ $(DEFS) $(INCLUDES) @CPPFLAGS@
LDFLAGS = @LDFLAGS@
MODLIBS = @MODLIBS@

@MAKEIFGNU@ MAKE # GNU make
FILENAME = $(shell /usr/bin/basename `pwd`)
CFILES = $(wildcard *.c)
HFILES = $(wildcard *.h)
HELPFILES = $(wildcard *.help)
DOCFILES = $(wildcard *.ref)
OBJS = $(CFILES:%.c=%.o)
FILENAMESUB = $(shell echo $(FILENAME) | sed 's/-/_/g')
EXTRAMODLIBS = $(shell ($(MODLIBS); echo $$MODLIBS_$(FILENAMESUB)))
@MAKEELSE@ # BSD make
FILENAME != /usr/bin/basename $(.CURDIR)
ALLFILES != /bin/ls
CFILES = ${ALLFILES:M*.c}
HFILES = ${ALLFILES:M*.h}
HELPFILES = ${ALLFILES:M*.help}
DOCFILES = ${ALLFILES:M*.ref}
OBJS = ${CFILES:S/.c$/.o/}
FILENAMESUB = ${FILENAME:S/-/_/g}
EXTRAMODLIBS != $(MODLIBS); echo $$MODLIBS_$(FILENAMESUB)
^ := $>
@MAKEENDIF@

srcdir = @srcdir@
top_srcdir = ../..
top_builddir = ../..
subdir := modules/$(FILENAME)
mdistdir := ${top_builddir}/@PACKAGE@-@VERSION@/$(subdir)

DISTFILES = $(CFILES) $(HFILES) $(HELPFILES) $(DOCFILES)

all static: $(OBJS)

modules: $(FILENAME).so

clean:
	rm -f *.o *.so core *~

$(FILENAME).so: $(OBJS)
	@LD@ $(LDFLAGS) -o $@ $^ $(EXTRAMODLIBS)
       
.c.o: $(HFILES) ${top_srcdir}/core/modules.h ${top_srcdir}/core/foxeye.h ${top_srcdir}/core/protos.h
	@CC@ -o $@ $(CFLAGS) -D_STATIC_INIT=modinit_$(FILENAMESUB) $<

install-help:
	$(mkinstalldirs) $(DESTDIR)$(helpdir)
	@list='$(HELPFILES)'; for p in $$list; do \
	    if test -f $$p; then \
		hp=`echo $$p|sed s/.help$$//`; \
		echo "   $(DESTDIR)$(helpdir)/$$hp"; \
		$(INSTALL) $$p $(DESTDIR)$(helpdir)/$$hp; \
	    else :; fi \
	done

install-docs:
	$(mkinstalldirs) $(DESTDIR)$(docdir)
	@list='$(DOCFILES)'; for p in $$list; do \
	    if test -f $$p; then \
		echo "   $(DESTDIR)$(docdir)/$$p"; \
		$(INSTALL) $$p $(DESTDIR)$(docdir)/$$p; \
	    else :; fi \
	done

install install-strip: modules install-help install-docs
	$(mkinstalldirs) $(DESTDIR)$(pkglibdir)
	@if test -f $(FILENAME).so; then \
	    echo "   $(DESTDIR)$(pkglibdir)/$(FILENAME).so"; \
	    $(INSTALL) $(FILENAME).so $(DESTDIR)$(pkglibdir)/$(FILENAME).so; \
	else :; fi

uninstall-help:
	@list='$(HELPFILES)'; for p in $$list; do \
	    hp=`echo $$p|sed s/.help$$//`; \
	    echo "  rm -f $(DESTDIR)$(helpdir)/$$hp"; \
	    rm -f $(DESTDIR)$(helpdir)/$$hp; \
	done

uninstall-docs:
	@list='$(DOCFILES)'; for p in $$list; do \
	    echo "  rm -f $(DESTDIR)$(docdir)/$$p"; \
	    rm -f $(DESTDIR)$(docdir)/$$p; \
	done

uninstall: uninstall-help uninstall-docs
	@if test -f $(DESTDIR)$(pkglibdir)/$(FILENAME).so; then \
	    echo "  rm -f $(DESTDIR)$(pkglibdir)/$(FILENAME).so"; \
	    rm -f $(DESTDIR)$(pkglibdir)/$(FILENAME).so; \
	else :; fi

dist distdir:
	@$(mkinstalldirs) $(mdistdir)
	@dists="$(DISTFILES)"; \
	for file in $$dists; do \
	    ln $(srcdir)/$$file $(mdistdir) 2> /dev/null \
	    || cp -p $(srcdir)/$$file $(mdistdir); \
	done

.PHONY: all static modules clean install-help install-docs \
	install install-strip uninstall-help uninstall-docs uninstall \
	dist distdir
